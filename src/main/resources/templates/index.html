<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¤– AI ì±—ë´‡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
            height: calc(100vh - 40px);
        }

        .sidebar {
            width: 300px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow-y: auto;
        }

        .main-content {
            flex: 1;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 28px;
        }

        h2 {
            color: #555;
            margin: 20px 0 10px 0;
            font-size: 20px;
        }

        .section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .section:last-child {
            border-bottom: none;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #666;
            font-weight: 500;
        }

        input[type="text"],
        input[type="password"],
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        input[type="range"] {
            width: 100%;
        }

        .slider-value {
            text-align: center;
            margin-top: 5px;
            color: #667eea;
            font-weight: bold;
        }

        button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .info-box {
            background: #f0f7ff;
            border-left: 4px solid #667eea;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 13px;
            color: #555;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 13px;
            color: #856404;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.assistant .message-avatar {
            background: #e0e0e0;
            color: #666;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        .send-button:hover {
            transform: scale(1.1);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .loading.show {
            display: block;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #666;
        }

        .model-status {
            background: #f0f7ff;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            display: none;
        }

        .model-status.loading {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .model-status.ready {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .model-status.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h2>âš™ï¸ ì„¤ì •</h2>

            <div class="section" style="display: none;">
                <label>AI íƒ€ì… ì„ íƒ</label>
                <select id="aiType" title="AI íƒ€ì… ì„ íƒ" onchange="updateAiSettings()">
                    <option value="Google Gemini" selected>Google Gemini</option>
                </select>
            </div>

            <div class="section" id="geminiSection">
                <label>Gemini ëª¨ë¸ ì„ íƒ</label>
                <select id="geminiModel" title="Gemini ëª¨ë¸ ì„ íƒ">
                    <option value="gemini-pro">gemini-pro</option>
                    <option value="gemini-1.5-flash">gemini-1.5-flash</option>
                    <option value="gemini-1.5-pro">gemini-1.5-pro</option>
                </select>
                <label style="margin-top: 10px;">Gemini API í‚¤</label>
                <input type="password" id="geminiApiKey" placeholder="API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”" title="Gemini API í‚¤" value="AIzaSyBHhFyXxCoOAU_BdMoPib2SO-mHA2z_1SA">
                <div class="info-box" style="margin-top: 10px; background: #fff3cd; border-left-color: #ffc107;">
                    <small>ğŸ”‘ API í‚¤ ë°œê¸‰: <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener">Google AI Studio</a></small><br>
                    <small>âœ… ë¬´ë£Œë¡œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤</small>
                </div>
            </div>

            <div class="section">
                <label>ì˜¨ë„ ì„¤ì •: <span id="temperatureValue">0.7</span></label>
                <input type="range" id="temperature" title="ì˜¨ë„ ì„¤ì •" min="0" max="1" step="0.1" value="0.7">
            </div>

            <div id="modelStatus" class="model-status"></div>

            <button onclick="clearChat()">ëŒ€í™” ê¸°ë¡ ì´ˆê¸°í™”</button>
        </div>

        <div class="main-content">
            <h1>ğŸ¤– AI ì±—ë´‡</h1>
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="empty-state">
                        <h3>ğŸ’¬ ìœ„ì˜ ì…ë ¥ì°½ì— ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ê³  Enterë¥¼ ëˆ„ë¥´ë©´ AIì™€ ëŒ€í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!</h3>
                    </div>
                </div>
                <div class="loading" id="loading">ìƒê° ì¤‘...</div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="handleKeyPress(event)">
                    <button class="send-button" onclick="sendMessage()">â¤</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // AI ì„¤ì • ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateAiSettings() {
            // Geminië¡œ ê³ ì •
            const statusDiv = document.getElementById('modelStatus');
            statusDiv.className = 'model-status ready show';
            statusDiv.textContent = 'âœ… Gemini ì¤€ë¹„ë¨';
        }


        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ìƒíƒœ ì„¤ì •
        document.addEventListener('DOMContentLoaded', function() {
            updateAiSettings();
        });

        // ë¸Œë¼ìš°ì € ì°½ì´ ë‹«í ë•Œ ì„œë²„ ì¢…ë£Œ ìš”ì²­
        let isClosing = false;
        window.addEventListener('beforeunload', function(event) {
            if (!isClosing) {
                isClosing = true;
                // ì„œë²„ ì¢…ë£Œ ìš”ì²­ (ë™ê¸°ì ìœ¼ë¡œ ë³´ë‚´ê¸°)
                try {
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', '/shutdown', false); // false = ë™ê¸° ìš”ì²­
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.send();
                    console.log('ì„œë²„ ì¢…ë£Œ ìš”ì²­ ì „ì†¡ë¨');
                } catch (e) {
                    console.error('ì„œë²„ ì¢…ë£Œ ìš”ì²­ ì‹¤íŒ¨:', e);
                }
            }
        });

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œì—ë„ ì„œë²„ ì¢…ë£Œ ìš”ì²­
        window.addEventListener('unload', function() {
            if (!isClosing) {
                isClosing = true;
                try {
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', '/shutdown', false);
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.send();
                } catch (e) {
                    // ë¬´ì‹œ (í˜ì´ì§€ê°€ ì´ë¯¸ ë‹«íˆëŠ” ì¤‘)
                }
            }
        });

        document.getElementById('temperature').addEventListener('input', function() {
            document.getElementById('temperatureValue').textContent = this.value;
        });

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        let lastPrompt = ''; // ë§ˆì§€ë§‰ ë©”ì‹œì§€ ì €ì¥ (ìë™ ì¬ì‹œë„ìš©)
        let isRetrying = false; // ì¬ì‹œë„ ì¤‘ì¸ì§€ ì¶”ì 
        let retryCountdownInterval = null; // ì¬ì‹œë„ ì¹´ìš´íŠ¸ë‹¤ìš´ ì¸í„°ë²Œ
        let loadingDiv = null; // ë¡œë”© div ì°¸ì¡° ì €ì¥

        function sendMessage() {
            // ì¬ì‹œë„ ì¤‘ì´ë©´ ìƒˆ ìš”ì²­ ì°¨ë‹¨
            if (isRetrying) {
                console.log('âš ï¸ ì¬ì‹œë„ ëŒ€ê¸° ì¤‘ì´ë¯€ë¡œ ìƒˆ ìš”ì²­ì„ ì°¨ë‹¨í•©ë‹ˆë‹¤.');
                return;
            }

            console.log('ğŸ“¤ ë©”ì‹œì§€ ì „ì†¡ ì‹œì‘:', lastPrompt || 'ìƒˆ ë©”ì‹œì§€');

            const input = document.getElementById('chatInput');
            let prompt = input.value.trim();

            // ì…ë ¥ì´ ì—†ìœ¼ë©´ ë§ˆì§€ë§‰ ë©”ì‹œì§€ ì‚¬ìš© (ìë™ ì¬ì‹œë„ìš©)
            if (!prompt && lastPrompt) {
                prompt = lastPrompt;
            } else if (!prompt) {
                return;
            }

            // ì…ë ¥ì´ ìˆìœ¼ë©´ ì €ì¥
            if (input.value.trim()) {
                lastPrompt = input.value.trim();
                input.value = '';
            }

            const messagesDiv = document.getElementById('chatMessages');
            const emptyState = messagesDiv.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ (ì¤‘ë³µ ë°©ì§€)
            const lastUserMessage = messagesDiv.querySelector('.message.user:last-child');
            if (!lastUserMessage || lastUserMessage.textContent.trim() !== prompt) {
                addMessage('user', prompt);
            }

            // ë¡œë”© í‘œì‹œ
            loadingDiv = document.getElementById('loading');
            loadingDiv.classList.add('show');
            loadingDiv.textContent = 'ìƒê° ì¤‘...';

            // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸ (ì£¼ê¸°ì ìœ¼ë¡œ)
            let progressCounter = 0;
            const progressInterval = setInterval(() => {
                progressCounter++;
                const seconds = Math.floor(progressCounter / 10);
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;

                let statusText = '';
                if (seconds < 60) {
                    statusText = 'ìƒê° ì¤‘... (' + seconds + 'ì´ˆ)';
                } else {
                    statusText = 'ìƒê° ì¤‘... (' + minutes + 'ë¶„ ' + remainingSeconds + 'ì´ˆ)';
                }

                // 2ë¶„ ì´ìƒ ê²½ê³¼ ì‹œ ì¶”ê°€ ì•ˆë‚´
                if (seconds >= 120) {
                    statusText += ' - ëª¨ë¸ ë¡œë”© ì¤‘ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤';
                }

                loadingDiv.textContent = statusText;
            }, 100);

            // ì™„ë£Œ ì‹œ ì¸í„°ë²Œ ì •ë¦¬
            const clearProgress = () => {
                clearInterval(progressInterval);
            };

            // íƒ€ì„ì•„ì›ƒ ì„¤ì • (3ë¶„ - ë°±ì—”ë“œê°€ 120ì´ˆ ë‚´ì— ì‘ë‹µí•˜ë¯€ë¡œ ì—¬ìœ  ìˆìŒ)
            let timeoutId = null;
            const timeoutPromise = new Promise((_, reject) => {
                timeoutId = setTimeout(() => {
                    clearProgress(); // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸ ì¤‘ì§€
                    console.error('íƒ€ì„ì•„ì›ƒ ë°œìƒ (3ë¶„ ì´ˆê³¼)');
                    reject(new Error('ìš”ì²­ ì‹œê°„ ì´ˆê³¼'));
                }, 180000); // 3ë¶„ (180ì´ˆ)
            });

            // API í˜¸ì¶œ
            console.log('API í˜¸ì¶œ ì‹œì‘:', prompt);
            const requestStartTime = Date.now();

            Promise.race([
                fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        aiType: 'Google Gemini (ë¬´ë£Œ)',
                        prompt: prompt,
                        model: document.getElementById('geminiModel') ? document.getElementById('geminiModel').value : 'gemini-pro',
                        geminiApiKey: document.getElementById('geminiApiKey') ? document.getElementById('geminiApiKey').value : '',
                        openaiApiKey: '',
                        temperature: parseFloat(document.getElementById('temperature').value)
                    })
                }),
                timeoutPromise
            ])
            .then(response => {
                // ì‘ë‹µì´ ì˜¤ë©´ íƒ€ì„ì•„ì›ƒ ì·¨ì†Œ
                if (timeoutId) {
                    clearTimeout(timeoutId);
                    timeoutId = null;
                }

                const elapsedTime = Date.now() - requestStartTime;
                console.log('ì‘ë‹µ ë°›ìŒ (ì†Œìš” ì‹œê°„: ' + elapsedTime + 'ms), ìƒíƒœ ì½”ë“œ: ' + response.status);

                if (!response.ok) {
                    console.error('HTTP ì˜¤ë¥˜:', response.status, response.statusText);
                    throw new Error('HTTP ì˜¤ë¥˜: ' + response.status + ' ' + response.statusText);
                }

                if (response instanceof Response) {
                    return response.json().then(data => {
                        console.log('JSON íŒŒì‹± ì™„ë£Œ:', data);
                        return data;
                    }).catch(err => {
                        console.error('JSON íŒŒì‹± ì˜¤ë¥˜:', err);
                        throw new Error('ì‘ë‹µ íŒŒì‹± ì˜¤ë¥˜: ' + err.message);
                    });
                } else {
                    throw new Error('ì‘ë‹µ ì˜¤ë¥˜');
                }
            })
            .then(data => {
                // íƒ€ì„ì•„ì›ƒì´ ì•„ì§ ì·¨ì†Œë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì·¨ì†Œ
                if (timeoutId) {
                    clearTimeout(timeoutId);
                    timeoutId = null;
                }

                clearProgress(); // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸ ì¤‘ì§€
                const totalTime = Date.now() - requestStartTime;
                console.log('ì „ì²´ ì²˜ë¦¬ ì™„ë£Œ (ì´ ì†Œìš” ì‹œê°„: ' + totalTime + 'ms)');

                // ì¬ì‹œë„ ì¤‘ì´ ì•„ë‹ˆë©´ ë¡œë”© í‘œì‹œ ì œê±°
                if (!isRetrying) {
                    document.getElementById('loading').classList.remove('show');
                }

                // ì‘ë‹µ ë°ì´í„° í™•ì¸
                if (!data) {
                    console.error('ì‘ë‹µ ë°ì´í„°ê°€ nullì…ë‹ˆë‹¤');
                    throw new Error('ì‘ë‹µ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
                }

                if (!data.message) {
                    console.error('ì‘ë‹µì— message í•„ë“œê°€ ì—†ìŠµë‹ˆë‹¤:', data);
                    throw new Error('ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜: message í•„ë“œê°€ ì—†ìŠµë‹ˆë‹¤');
                }

                // ëª¨ë¸ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì‘ë‹µ ë©”ì‹œì§€ì— ë”°ë¼)
                const message = data.message;
                console.log('ì‘ë‹µ ë©”ì‹œì§€ ê¸¸ì´:', message.length, 'ì');
                const statusDiv = document.getElementById('modelStatus');

                // 429 ì˜¤ë¥˜ ì²˜ë¦¬ - ì¬ì‹œë„ ì‹œê°„ì´ ìˆìœ¼ë©´ ìë™ ì¬ì‹œë„
                if (message.includes('API í• ë‹¹ëŸ‰ ì´ˆê³¼')) {
                    statusDiv.className = 'model-status loading show';
                    statusDiv.textContent = 'âš ï¸ í• ë‹¹ëŸ‰ ì´ˆê³¼';

                    // ì¬ì‹œë„ ì‹œê°„ ì¶”ì¶œ
                    if (message.includes('ì¬ì‹œë„ ì‹œê°„')) {
                        // "â° ì¬ì‹œë„ ì‹œê°„: ì•½ 59ì´ˆ í›„" ë˜ëŠ” "ì¬ì‹œë„ ì‹œê°„: ì•½ 59ì´ˆ" í˜•ì‹ ëª¨ë‘ ì§€ì›
                        const retryMatch = message.match(/ì¬ì‹œë„ ì‹œê°„: ì•½ (\d+)ì´ˆ/);
                        if (retryMatch) {
                            const retrySeconds = parseInt(retryMatch[1]);

                            // ì¬ì‹œë„ ì‹œê°„ì´ 60ì´ˆ ì´í•˜ë©´ ìë™ ì¬ì‹œë„
                            if (retrySeconds > 0 && retrySeconds <= 60) {
                                console.log('ğŸ”„ ìë™ ì¬ì‹œë„ ì˜ˆì•½: ' + retrySeconds + 'ì´ˆ í›„');

                                // ê¸°ì¡´ ì¹´ìš´íŠ¸ë‹¤ìš´ ì¸í„°ë²Œì´ ìˆìœ¼ë©´ ì •ë¦¬
                                if (retryCountdownInterval) {
                                    clearInterval(retryCountdownInterval);
                                }

                                isRetrying = true; // ì¬ì‹œë„ ì¤‘ í”Œë˜ê·¸ ì„¤ì •
                                addMessage('assistant', message + '\n\nâ³ ' + retrySeconds + 'ì´ˆ í›„ ìë™ìœ¼ë¡œ ì¬ì‹œë„í•©ë‹ˆë‹¤...');

                                // ì¬ì‹œë„ ì¹´ìš´íŠ¸ ë‹¤ìš´ í‘œì‹œ
                                let countdown = retrySeconds;
                                const currentLoadingDiv = document.getElementById('loading'); // ë¡œë”© div ê°€ì ¸ì˜¤ê¸°
                                currentLoadingDiv.classList.add('show'); // ë¡œë”© í‘œì‹œ ìœ ì§€
                                retryCountdownInterval = setInterval(() => {
                                    countdown--;
                                    if (countdown > 0) {
                                        statusDiv.textContent = 'âš ï¸ í• ë‹¹ëŸ‰ ì´ˆê³¼ - ' + countdown + 'ì´ˆ í›„ ì¬ì‹œë„';
                                        currentLoadingDiv.textContent = 'ì¬ì‹œë„ ëŒ€ê¸° ì¤‘... (' + countdown + 'ì´ˆ)';
                                    } else {
                                        clearInterval(retryCountdownInterval);
                                        retryCountdownInterval = null;
                                        statusDiv.textContent = 'ğŸ”„ ì¬ì‹œë„ ì¤‘...';
                                        currentLoadingDiv.textContent = 'ì¬ì‹œë„ ì¤‘...';

                                        // ìë™ ì¬ì‹œë„ ì‹¤í–‰
                                        console.log('ğŸ”„ ìë™ ì¬ì‹œë„ ì‹œì‘: ë§ˆì§€ë§‰ ë©”ì‹œì§€ ì¬ì „ì†¡');
                                        setTimeout(() => {
                                            isRetrying = false; // ì¬ì‹œë„ ì‹œì‘ ì „ í”Œë˜ê·¸ í•´ì œ
                                            sendMessage(); // ë§ˆì§€ë§‰ ë©”ì‹œì§€ ìë™ ì¬ì‹œë„
                                        }, 1000);
                                    }
                                }, 1000);

                                return; // ì—¬ê¸°ì„œ ì¢…ë£Œí•˜ì—¬ ì¤‘ë³µ ë©”ì‹œì§€ ë°©ì§€
                            } else if (retrySeconds > 60) {
                                // ì¬ì‹œë„ ì‹œê°„ì´ 60ì´ˆ ì´ˆê³¼ë©´ ìˆ˜ë™ ì¬ì‹œë„ ì•ˆë‚´
                                addMessage('assistant', message + '\n\nâš ï¸ ì¬ì‹œë„ ì‹œê°„ì´ ' + retrySeconds + 'ì´ˆë¡œ ê¸¸ì–´ì„œ ìë™ ì¬ì‹œë„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n' +
                                    'ì¬ì‹œë„ ì‹œê°„ì´ ì§€ë‚œ í›„ ìˆ˜ë™ìœ¼ë¡œ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\n\n' +
                                    'ğŸ’¡ ì¦‰ì‹œ ì‚¬ìš©í•˜ë ¤ë©´ ìƒˆ API í‚¤ë¥¼ ë°œê¸‰ë°›ê±°ë‚˜ ë‹¤ë¥¸ API í‚¤ë¥¼ ì‚¬ìš©í•´ë³´ì„¸ìš”.');
                                return;
                            }
                        }
                    }

                    // ì¬ì‹œë„ ì‹œê°„ ì •ë³´ê°€ ì—†ìœ¼ë©´ ì¼ë°˜ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
                    addMessage('assistant', message);
                    return;
                }

                if (message.includes('â³ AI ëª¨ë¸ ì—°ê²° ì¤‘') || message.includes('ë¡œë”© ì‹œê°„ì´ í•„ìš”') || message.includes('ë¡œë”© ì¤‘')) {
                    // ë¡œë”© ì¤‘
                    statusDiv.className = 'model-status loading show';
                    statusDiv.textContent = 'â³ ëª¨ë¸ ë¡œë”© ì¤‘...';
                } else if (message.includes('âŒ') || message.includes('ì˜¤ë¥˜') || message.includes('ì‹¤íŒ¨')) {
                    // ì˜¤ë¥˜
                    statusDiv.className = 'model-status loading show';
                    statusDiv.textContent = 'âš ï¸ ì—°ê²° ì‹¤íŒ¨';
                } else {
                    // ì‚¬ìš© ê°€ëŠ¥ (ì‹¤ì œ AI ì‘ë‹µ ë°›ìŒ)
                    statusDiv.className = 'model-status ready show';
                    statusDiv.textContent = 'âœ… ì‚¬ìš© ê°€ëŠ¥';
                }

                addMessage('assistant', message);
            })
            .catch(error => {
                // íƒ€ì„ì•„ì›ƒ ì·¨ì†Œ
                if (timeoutId) {
                    clearTimeout(timeoutId);
                    timeoutId = null;
                }

                clearProgress(); // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸ ì¤‘ì§€
                const elapsedTime = Date.now() - requestStartTime;
                console.error('ì˜¤ë¥˜ ë°œìƒ (ì†Œìš” ì‹œê°„: ' + elapsedTime + 'ms):', error);
                console.error('ì˜¤ë¥˜ íƒ€ì…:', error.constructor.name);
                console.error('ì˜¤ë¥˜ ë©”ì‹œì§€:', error.message);
                console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);

                // ì¬ì‹œë„ ì¤‘ì´ ì•„ë‹ˆë©´ ë¡œë”© í‘œì‹œ ì œê±°
                if (!isRetrying) {
                    document.getElementById('loading').classList.remove('show');
                }

                // ì¬ì‹œë„ í”Œë˜ê·¸ í•´ì œ (429 ì˜¤ë¥˜ê°€ ì•„ë‹Œ ê²½ìš°)
                if (!error.message.includes('429') && !error.message.includes('í• ë‹¹ëŸ‰')) {
                    isRetrying = false;
                }
                const statusDiv = document.getElementById('modelStatus');
                // ë¬´ë£Œ AI ì±—ë´‡ë§Œ ì‚¬ìš©

                statusDiv.className = 'model-status loading show';
                statusDiv.textContent = 'âš ï¸ ì—°ê²° ì‹¤íŒ¨';

                let errorMessage = '';
                if (error.message === 'ìš”ì²­ ì‹œê°„ ì´ˆê³¼' || error.message.includes('timeout')) {
                    errorMessage = 'â³ ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n' +
                        'ê³µê°œ ë¬´ë£Œ ëª¨ë¸ì€ ë¡œë”© ì‹œê°„ì´ í•„ìš”í•©ë‹ˆë‹¤.\n\n' +
                        'ğŸ’¡ í•´ê²° ë°©ë²•:\n' +
                        '1. â° 1-2ë¶„ í›„ ë‹¤ì‹œ ì‹œë„ (ëª¨ë¸ ë¡œë”© ì™„ë£Œ ëŒ€ê¸°)\n' +
                        '2. ğŸ”„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„\n' +
                        '3. ğŸŒ ì¸í„°ë„· ì—°ê²° í™•ì¸\n' +
                        '4. ì½˜ì†” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ìƒì„¸ ì˜¤ë¥˜ í™•ì¸';
                } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMessage = 'âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n' +
                        'ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\n' +
                        'ğŸ’¡ í•´ê²° ë°©ë²•:\n' +
                        '1. ğŸŒ ì¸í„°ë„· ì—°ê²° í™•ì¸\n' +
                        '2. ğŸ”„ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸\n' +
                        '3. ğŸ”„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„\n' +
                        '4. ì½˜ì†”(F12)ì—ì„œ ìƒì„¸ ì˜¤ë¥˜ í™•ì¸';
                } else {
                    errorMessage = 'âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message + '\n\n' +
                        'ğŸ’¡ í•´ê²° ë°©ë²•:\n' +
                        '1. ğŸ”„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„\n' +
                        '2. ì½˜ì†”(F12)ì—ì„œ ìƒì„¸ ì˜¤ë¥˜ í™•ì¸\n' +
                        '3. ì„œë²„ ì½˜ì†” ë¡œê·¸ í™•ì¸';
                }

                addMessage('assistant', errorMessage);
            });
        }

        function getSelectedModel() {
            // ë¬´ë£Œ AI ì±—ë´‡ë§Œ ì‚¬ìš©í•˜ë¯€ë¡œ ëª¨ë¸ ì„ íƒ ë¶ˆí•„ìš”
            return '';
        }

        function addMessage(role, content) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = content;

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            messagesDiv.appendChild(messageDiv);

            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function clearChat() {
            if (confirm('ëŒ€í™” ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                fetch('/clear', {
                    method: 'POST'
                })
                .then(() => {
                    document.getElementById('chatMessages').innerHTML =
                        '<div class="empty-state"><h3>ğŸ’¬ ìœ„ì˜ ì…ë ¥ì°½ì— ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ê³  Enterë¥¼ ëˆ„ë¥´ë©´ AIì™€ ëŒ€í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!</h3></div>';
                });
            }
        }
    </script>
</body>
</html>

